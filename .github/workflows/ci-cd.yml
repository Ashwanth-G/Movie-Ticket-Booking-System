# CI/CD: Build → Test → Dockerize → Push to Docker Hub
# Secrets: DOCKERHUB_USERNAME, DOCKERHUB_TOKEN
# Optional: RENDER_DEPLOY_HOOK_URL (for Render deploy hook)

name: CI/CD Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  REGISTRY: docker.io

jobs:
  # --- Backend: install, test (with MongoDB) ---
  test-backend:
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci || npm install

      - name: Run backend tests
        working-directory: ./backend
        env:
          MONGODB_URI: mongodb://localhost:27017/movie-booking-test
          JWT_SECRET: test-secret
        run: npm test -- --passWithNoTests

  # --- Frontend: install, build ---
  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci || npm install

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

  # --- Docker: build images, push to Docker Hub (on main/master only) ---
  docker-build-push:
    runs-on: ubuntu-latest
    needs: [test-backend, build-frontend]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata (backend)
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/movie-booking-backend
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Extract metadata (frontend)
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/movie-booking-frontend
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Optional: trigger Render deploy (set RENDER_DEPLOY_HOOK_URL in repo secrets)
      - name: Trigger Render deploy
        if: secrets.RENDER_DEPLOY_HOOK_URL != ''
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
        continue-on-error: true
